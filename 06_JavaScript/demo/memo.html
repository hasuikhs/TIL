<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memo</title>
    <style>
      .section {
        display: flex;
        padding: 10px;
        justify-content: space-between;
      }
      .title {
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 600;
        min-width: 200px;
        height: inherit;
        border-right: 1px solid black;
        margin-right: 10px;
      }
      p {
        word-break: break-word;
      }
      .memo {
        font-style: italic;
        font-weight: 600;
        background-color: #f9f9c8;
      }
      .modal {
        position: absolute;
        top: 50%;
        left: 50%;
        margin-left: -140px;
        display: flex;
        margin-top: -50px;
        visibility: hidden;
        opacity: 0;
        justify-content: space-between;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid black;
        width: 300px;
        height: 100px;
        background-color: white;
        box-shadow: 5px 5px 5px #d6d6d6;
        transition: ease 0.3s;
      }
      .memo-input {
        width: 200px;
        height: 93px;
        resize: none;
      }
    </style>
  </head>
  <body>
    <h1>MEMO TEST</h1>

    <div key="FIELD_OF_THE_INVENTION" id="FIELD_OF_THE_INVENTION">
      <p>
        <strong>【Paragraph 1】</strong>
      </p>
      <div key="P-0003" id="P-0003">
        <p>
          <strong>【0001】</strong>
        </p>
        Lorem ipsum dolor sit amet consectetur adipisicing elit. Ab asperiores,
        ullam architecto omnis voluptatum dolor quia, est, saepe earum fugiat
        consectetur dicta autem corporis nemo delectus totam. Doloremque
        voluptate molestiae laboriosam possimus sed? Excepturi veritatis,
        blanditiis ea ratione obcaecati magnam earum magni temporibus officiis
        error porro incidunt ipsum quae repudiandae expedita fugiat itaque
        delectus. Ad quisquam provident odio. Quo iste, in explicabo, nulla
        tempore animi quasi ducimus numquam sint et perferendis ratione
        accusamus mollitia debitis earum voluptates. Cumque officiis expedita
        consequuntur libero labore, assumenda, explicabo dicta, maiores hic
        earum illum modi voluptate consequatur rerum ducimus voluptatum
        doloribus accusantium animi saepe!
        <mark
          data-markjs="true"
          id="-1204461845-1-1"
          name="-1204461845-1"
          class="mark--1204461845 palette-fac76c"
          >organic</mark
        >
        Lorem ipsum dolor sit amet consectetur adipisicing elit. Deserunt,
        sapiente.
      </div>
    </div>

    <div key="FIELD_OF_THE_INVENTION" id="FIELD_OF_THE_INVENTION_2">
      <p>
        <strong>【Paragraph 2】</strong>
      </p>
      <div key="P-0004" id="P-0004">
        <p>
          <strong>【0002】</strong>
        </p>
        Lorem ipsum dolor sit amet consectetur adipisicing elit. Tenetur est
        nemo officiis, qui nam amet enim consequuntur itaque voluptate facilis,
        blanditiis numquam. Magni, veritatis aperiam a modi labore esse nisi
        libero cupiditate possimus, tenetur hic corrupti nemo voluptas
        distinctio deleniti cum quos dolores sapiente temporibus, expedita
        molestias deserunt consequatur maiores! Excepturi inventore quia illum
        ipsam corrupti sint suscipit id molestias accusamus rem voluptatum,
        libero illo dolor fuga exercitationem nam, minima minus assumenda
        dolores. Aliquam corporis odio illo id ex molestias a tempore explicabo
        ad, libero sequi fugit ipsa magnam incidunt veritatis nesciunt atque at
        non eum iusto? Laudantium, molestias eius!
        <mark
          data-markjs="true"
          id="-1204461845-1-1"
          name="-1204461845-1"
          class="mark--1204461845 palette-fac76c"
          >organic</mark
        >
        Lorem ipsum dolor sit amet consectetur adipisicing elit. Magnam
        distinctio modi suscipit quibusdam repellendus, culpa ab dicta ut
        numquam explicabo?
      </div>
    </div>

    <div id="memo-modal" class="modal">
      <textarea
        class="memo-input"
        placeholder="메모를 입력해주세요."
        maxlength="100"
      ></textarea>
      <button class="save-btn" type="button">저장</button>
      <button class="cancel-btn" type="button">취소</button>
    </div>

    <script>
      window.onload = () => {
        const sessionData = JSON.parse(sessionStorage.getItem("data"));
        console.log(sessionData);

        if (sessionData) {
          const target = document.getElementById(sessionData.target);

          const targetText = target.textContent.slice(
            sessionData.start,
            sessionData.end
          );

          target.innerHTML = target.textContent.replace(
            targetText,
            `<span class="memo">${targetText}</span>`
          );
          console.log(target.textContent);
          // span.innerHTML = target.textContent.replace(target.textContent.slice(sessionData.start, sessionData.end))
          // const range = new Range();
        }

        // 1. 메모 드래그 관련
        document.addEventListener("mouseup", ({ target }) => {
          const selection = window.getSelection();
          const selectedText = selection.toString().trim();
          if (!selectedText) {
            return;
          }

          const { has, message } = getMemoEnableObject(target, selection);
          if (!has) {
            alert(message);
            return selection.removeAllRanges();
          }

          const parentTarget = target.closest("div[id]");
          if (selectedText) {
            highlightSelectedText(parentTarget, selection);
          }
        });

        // 2. 모달 관련
        const modalSaveBtn = document.querySelector(
          "#memo-modal > button.save-btn"
        );
        const modalCancelBtn = document.querySelector(
          "#memo-modal > button.cancel-btn"
        );

        // 2.1 모달 저장 버튼
        modalSaveBtn.addEventListener("click", () => {
          const memoText = document.querySelector(
            "#memo-modal > textarea.memo-input"
          ).value;

          const data = {
            documentId: "test",
            memoText,
          };

          // sessionStorage.setItem('saveData', JSON.stringify(data));

          hideModal();
        });

        // 2.2 모달 취소 버튼
        modalCancelBtn.addEventListener("click", () => {
          hideModal();
        });
      };

      // -----------------------------------------------------------------------------------------------------

      /*
       * function 모달 숨기기
       */
      function hideModal() {
        const modal = document.querySelector("#memo-modal");

        modal.style.opacity = 0;
        modal.style.visibility = "hidden";
        modal.querySelector("textarea.memo-input").value = "";
      }

      /*
       * function 모달 열기
       */
      function openModal() {
        const modal = document.querySelector("#memo-modal");

        modal.style.opacity = 1;
        modal.style.visibility = "visible";
        modal.querySelector("textarea.memo-input").focus();
      }

      // -----------------------------------------------------------------------------------------------------

      function highlightSelectedText(target, selection) {
        if (selection.rangeCount > 0) {
          let range = selection.getRangeAt(0);

          let preSelectionRange = range.cloneRange();
          preSelectionRange.selectNodeContents(target);
          preSelectionRange.setEnd(range.startContainer, range.startOffset);

          range.start = preSelectionRange.toString().length;
          range.end = range.start + range.toString().length;

          // console.log(range.toString())

          // 선택된 텍스트를 굵게 표시하기 위해 span 태그로 감싸기
          let span = document.createElement("span");
          span.className = "memo";
          span.appendChild(range.extractContents());
          range.insertNode(span);

          // 선택 해제
          selection.removeAllRanges();

          console.log(range);
          const memo = {
            target: target.id,
            start: range.start,
            end: range.end,
          };

          sessionStorage.setItem("data", JSON.stringify(memo));

          openModal();
        }
      }

      function getMemoEnableObject(element, selection) {
        let has = true;
        let message = "";

        if (document.querySelector("#memo-modal").style.opacity === "1") {
          has = false;
          message = "이미 메모가 진행 중";
        }

        if (element.classList.contains("memo")) {
          has = false;
          message = "이미 메모가 존재";
        }

        if (
          selection.anchorNode.parentNode.closest("p") !==
          selection.focusNode.parentNode.closest("p")
        ) {
          has = false;
          message = "메모는 한 문단 안에서만 가능";
        }

        if (has && selection.rangeCount > 0) {
          const range = selection.getRangeAt(0);

          let textNodes = getTextNodesWithinRange(range);

          for (let i = 0; i < textNodes.length; i++) {
            const node = textNodes[i];
            if (
              node.parentNode.classList &&
              node.parentNode.classList.contains("memo")
            ) {
              has = false;
              message = "메모는 중복 적용 불가능";
              break;
            }
          }
        }

        return { has, message };
      }

      function getTextNodesWithinRange(range) {
        const textNodes = [];
        const treeWalker = document.createTreeWalker(
          range.commonAncestorContainer,
          NodeFilter.SHOW_TEXT,
          null,
          false
        );

        let currentNode;
        while ((currentNode = treeWalker.nextNode())) {
          if (range.intersectsNode(currentNode)) {
            textNodes.push(currentNode);
          }
        }

        return textNodes;
      }

      /*
       * 현재 제한 사항
       * 1. 메모가 중복 될 수 없음
       * 2. 메모가 현재 문단을 벗어 날 수 없음
       */
    </script>
  </body>
</html>
