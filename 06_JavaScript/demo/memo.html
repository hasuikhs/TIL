<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Memo</title>
    <style>
      html {
        min-width: 1200px;
      }
      .section {
        display: flex;
        padding: 10px;
        justify-content: space-between;
      }
      .title {
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 600;
        min-width: 200px;
        height: inherit;
        border-right: 1px solid black;
        margin-right: 10px;
      }
      p {
        word-break: break-word;
      }
      .memo {
        font-style: italic;
        background-color: #f8ca8f;
      }
      .memo-hover {
        text-decoration: underline;
        cursor: pointer;
      }
      #memo-view {
        display: none;
        background-color: #a3dff0;
        position: fixed;
        height: 40px;
        width: 300px;
        padding: 3px 10px;
        color: white;
        border-radius: 5px;
        z-index: 90;
        box-shadow: 3px 3px 3px rgba(0, 0, 0, 0.3);
      }
      .modal-wrapper {
        display: none;
      }
      .modal {
        position: absolute;
        margin-left: -140px;
        display: none;
        margin-top: -50px;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid black;
        width: 300px;
        height: 120px;
        background-color: white;
        box-shadow: 5px 5px 5px #d6d6d6;
      }
      .modal-content {
        display: flex;
        height: 100%;
        justify-content: space-between;
      }
      .memo-input {
        padding: 5px;
        width: 200px;
        resize: none;
      }
      .memo-ing {
        background-color: #f9f9c8 !important;
      }
      .memo-update {
        animation: update-effect 1s 5;
      }
      .text-notice {
        position: absolute;
        top: 107px;
        left: 158px;
        pointer-events: none;
        width: 60px;
        text-align: right;
        opacity: 0.6;
      }
      #memo-popup {
        display: none;
        position: absolute;
        max-width: 110px;
        height: 24px;
        background-color: white;
        border: 1px solid #eaeaea;
        border-radius: 5px;
        padding: 4px;
        z-index: 100;
      }
      #memo-popup button.add {
        display: block;
        color: blue;
        font-weight: 600;
      }
      #memo-popup button.update {
        display: none;
        color: blue;
        font-weight: 600;
      }
      #memo-popup button.remove {
        display: none;
        color: red;
        font-weight: 600;
      }
      mark {
        background-color: aqua !important;
        border-radius: 5px;
      }
      mark > .memo {
        background-color: inherit;
      }
      em {
        background-color: #d6d6d6;
        font-style: normal;
        padding: 0px 10px;
        cursor: crosshair;
      }
      #memo-toggle {
        position: fixed;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        font-size: 25px;
        font-weight: 600;
        color: white;
        background-color: #39aac9;
        width: 60px;
        height: 60px;
        right: 15px;
        bottom: 15px;
        border-radius: 50%;
        transition: all ease 0.5s;
        box-shadow: 2px 2px 4px #D6D6D6;
      }
      #memo-toggle:hover {
        /* color: black; */
        background-color: #636363;
      }
      #memo-main {
        /* display: none; */
        position: fixed;
        width: 400px;
        height: 500px;
        right: -50%;
        bottom: 90px;
        border: 2px solid #EAEAEA;
        border-radius: 20px;
        background-color: white;
        transition:  all 0.7s ease-in-out;
        /* padding: 0 20px 20px 20px; */
      }
      #memo-tool-bar {
        background-color: #EAEAEA;
        border-radius: 15px 15px 0px 0px;
        padding: 5px;
      }
      #memo-main-close {
        position: absolute;
        right: 13px;
        top: 13px;
        color: #6d6d6d;
        font-weight: 600;
        cursor: pointer;
      }
      #memo-search {
        display: flex;
        width: 200px;
        margin-left: 50px;
      }
      #memo-search input {
        width: 100%;
        max-width: 320px;
        padding: 7px;
        font-size: 15px;
        margin-right: 2px;
      }
      #memo-search button {
        width: 50px;
      }
      #memo-tool {
        height: 50px;
      }
      #memo-content {
        height: 100%;
        max-height: 495px;
        overflow-y: scroll;
        scrollbar-width: none;
        -ms-overflow-style: none;
        border-radius: 12px;
        border: 1px solid #6c6c6c;
      }
      #memo-content::-webkit-scrollbar {
        display: none;
      }
      .memo-content-item {
        height: 100px;
        background-color: #eaeaea;
        margin: 10px 0px;
        border-radius: 20px;
      }
      .memo-content-item:first-child, .memo-content-item:last-child {
        margin: 0px;
      }
      @keyframes update-effect {
        50% {
          background-color: #fddbae;
        }
      }

      .tab-inde, .tab-all {
        display: none;
      }
      .visible {
        display: block;
      }
      .tab-group button:focus {
        background-color: yellow;
      }
    </style>
    
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  </head>
  <body>
    <h1>MEMO TEST</h1>

    <div id="container">
      <div key="FIELD_OF_THE_INVENTION" id="FIELD_OF_THE_INVENTION">
        <p>
          <strong>【Paragraph 1】</strong>
        </p>
        <div key="P-0003" id="P-0003">
          <p>
            <strong>【0001】</strong>
          </p>
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Ab
          asperiores, ullam architecto omnis voluptatum dolor quia, est, saepe
          earum fugiat consectetur dicta autem corporis nemo delectus totam.
          Doloremque voluptate molestiae laboriosam possimus sed? Excepturi
          veritatis, blanditiis ea ratione obcaecati magnam earum magni
          temporibus officiis error porro incidunt ipsum quae repudiandae
          expedita fugiat itaque delectus.
          Ad quisquam provident odio. Quo iste, in explicabo, nulla tempore
          animi quasi ducimus numquam sint et perferendis ratione accusamus
          mollitia debitis earum voluptates. Cumque officiis expedita
          consequuntur libero labore, assumenda, explicabo dicta, maiores hic
          earum illum modi voluptate consequatur rerum ducimus voluptatum
          doloribus accusantium animi saepe!
          <mark
            data-markjs="true"
            id="-1204461845-1-1"
            name="-1204461845-1"
            class="mark--1204461845 palette-fac76c"
            >organic</mark
          >
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Deserunt,
          sapiente.
        </div>
      </div>

      <div key="FIELD_OF_THE_INVENTION_2" id="FIELD_OF_THE_INVENTION_2">
        <p>
          <strong>【Paragraph 2】</strong>
        </p>
        <div key="P-0004" id="P-0004">
          <p>
            <strong>【0002】</strong>
          </p>
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Tenetur est
          nemo officiis, qui nam amet enim consequuntur itaque voluptate
          facilis, blanditiis numquam. Magni, veritatis aperiam a modi labore
          esse nisi libero cupiditate possimus, tenetur hic corrupti nemo
          voluptas distinctio deleniti cum quos dolores sapiente temporibus,
          expedita molestias deserunt consequatur maiores! Excepturi inventore
          quia illum ipsam corrupti sint suscipit id molestias accusamus rem
          voluptatum, libero illo dolor fuga exercitationem nam, minima minus
          assumenda dolores. Aliquam corporis odio illo id ex molestias a
          tempore explicabo ad, libero sequi fugit ipsa magnam incidunt
          veritatis nesciunt atque at non eum iusto? Laudantium, molestias eius!
          <mark
            data-markjs="true"
            id="-1204461845-1-1"
            name="-1204461845-1"
            class="mark--1204461845 palette-fac76c"
            >organic</mark
          >
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Magnam
          distinctio modi suscipit quibusdam repellendus, culpa ab dicta ut
          numquam explicabo?
        </div>
        <p>
          <strong>【Paragraph 3】</strong>
        </p>
        <div num="0003">
          <div>【0003】</div>
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Ratione ipsam
          placeat sapiente consequatur repudiandae, numquam similique, ad vel
          tempore dolorem eaque explicabo id temporibus voluptatibus quis harum
          ea saepe perferendis nulla corrupti? Iste fuga excepturi voluptate
          recusandae molestias, dolores numquam.
        </div>
        <div num="0004">
          <div>【0004】</div>
          Lorem ipsum dolor sit amet consectetur adipisicing elit. Rerum, molestias. Delectus eum ipsa harum sint magnam minima quam in alias unde eaque quisquam expedita modi voluptas ipsam ipsum aliquam architecto veniam, explicabo reprehenderit recusandae molestiae tempore amet labore? Adipisci corrupti laboriosam nisi perferendis officia rem dolorem sed libero non. Hic, placeat! Maiores error natus cumque recusandae ad ea animi necessitatibus dolores. Odit facilis tempora, esse deleniti nemo, unde quis maxime architecto nobis earum itaque. Itaque, corporis aspernatur obcaecati vero nobis unde eveniet velit, magni saepe quidem iure aliquam porro vitae sint iste esse doloremque facilis tempora sapiente cum placeat eius. Laborum eos vero ullam, neque quisquam odit vel eaque. Repudiandae unde molestiae at, soluta, dignissimos blanditiis ab consequatur similique id ullam sit aut quasi nobis aperiam maxime beatae doloremque quaerat possimus maiores quisquam inventore! Consequuntur reprehenderit maxime voluptates quo recusandae impedit nam! Iusto, similique. Dolores sunt, magnam commodi reprehenderit architecto vitae ducimus voluptatum culpa pariatur quis ipsa? A eligendi cupiditate, possimus rem veritatis iste nisi numquam provident porro dolor temporibus molestias explicabo obcaecati impedit praesentium expedita, fugiat odio ut odit. Recusandae quaerat commodi, alias fugit id provident asperiores. Eligendi dolorum id veritatis reiciendis ipsam labore officiis similique nemo quis est!
        </div>
        <div key="P-0005" id="P-0005">
          <p>
            <strong>【0005】</strong>
          </p>
          <span class="symbol" symbol="1">1</span> Lorem.<br>
          <img src="/test.png" height="200px"><br>
          <span class="symbol" symbol="2">2</span> Lorem, ipsum<sub>subtest</sub>.<br>
          <span class="symbol" symbol="3">3</span> Lorem, ipsum dolor.<br>
          <span class="symbol" symbol="4">4</span> Lorem ipsum dolor sit.<br>
          <span class="symbol" symbol="5">5</span> Lorem ipsum dolor sit <img src="/test.png" height="200px"> amet.<br>
          <span class="symbol" symbol="6">6</span> Lorem ipsum dolor sit amet consectetur.<br>
          <span class="symbol" symbol="7">7</span> Lorem ipsum dolor sit amet consectetur adipisicing.<br>
          <span class="symbol" symbol="8">8</span> Lorem ipsum dolor, sit amet consectetur adipisicing elit.<br>
          <span class="symbol" symbol="9">9</span> Lorem ipsum <em>IMAGE</em>dolor sit amet consectetur adipisicing elit. Voluptates!<br>
          <span class="symbol" symbol="10">10</span> Lorem ipsum dolor, sit amet consectetur adipisicing elit. Ab, ex!<br>
          <span class="symbol" symbol="11">11</span> Lorem ipsum dolor sit amet consectetur adipisicing elit. Repellat, similique fugiat.<br>
          <span class="symbol" symbol="12">12</span> Lorem ipsum dolor sit amet consectetur adipisicing elit. Dolores repudiandae quasi possimus.<br>
          <span class="symbol" symbol="13">13</span> Lorem ipsum dolor sit, amet consectetur adipisicing elit. Reprehenderit cupiditate obcaecati magni suscipit?<br>
          <span class="symbol" symbol="14">14</span> Lorem ipsum dolor sit amet consectetur adipisicing elit. Unde incidunt doloremque ipsum numquam voluptatem.<br>
          <span class="symbol" symbol="15">15</span> Lorem, ipsum dolor sit amet consectetur adipisicing elit. Hic laudantium porro nisi. Harum, amet eum.<br>
          <span class="symbol" symbol="16">16</span> Lorem ipsum, dolor sit amet consectetur adipisicing elit. Veritatis nam beatae, temporibus eligendi maxime alias itaque!<br>
          <span class="symbol" symbol="17">17</span> Lorem ipsum dolor sit, amet consectetur adipisicing elit. Illum laudantium asperiores error dicta adipisci? Iste, quam dignissimos!<br>
          <span class="symbol" symbol="18">18</span> Lorem ipsum, dolor sit amet consectetur adipisicing elit. Debitis eligendi nulla voluptatibus id nisi earum a eum cum?<br>
          <span class="symbol" symbol="19">19</span> Lorem ipsum dolor sit amet consectetur adipisicing elit. Laborum sit dolorum omnis atque expedita asperiores, velit quam quae aliquid!<br>
        </div>
        <div key="P-0082" id="P-0082">
          <div id="TABLE-US-00001-0000" type="TABLE" style="text-align: center;padding: 10px;width: calc(100%-20px);">
            <table></table>
            <table>
              <colgroup>
                <col style="width: 100.00%;">
              </colgroup>
              <thead>
                <tr>
                  <td nameend="1" namest="1" rowsep="1">
                    <strong><span data-markjs="true" class="search-highlight">TABLE</span> 1</strong>
                  </td>
                </tr>
              </thead>
              <tbody valign="top">
                <tr style="border-bottom: 1px solid rgb(203, 203, 203);">
                  <td align="center" nameend="1" namest="1" rowsep="1" colspan="1" style="text-align:left"></td>
                </tr>
                <tr style="border-bottom: 1px solid rgb(203, 203, 203);">
                  <td style="text-align:left">Example Biosignal Data and Source</td>
                </tr>
              </tbody>
            </table>
            <table>
              <colgroup>
                <col style="width: 19.05%;">
                <col style="width: 21.43%;">
                <col style="width: 26.19%;">
                <col style="width: 33.33%;">
              </colgroup>
              <tbody valign="top">
                <tr style="border-bottom: 1px solid rgb(203, 203, 203);">
                  <th style="text-align:left">Category</th>
                  <th style="text-align:left">Type</th>
                  <th style="text-align:left">Signal</th>
                  <th style="text-align:left">Source</th>
                </tr>
                <tr style="border-bottom: 1px solid rgb(203, 203, 203);">
                  <td align="center" nameend="4" namest="1" rowsep="1" colspan="4" style="text-align:left"></td>
                </tr>
                <tr style="border-bottom: 1px solid rgb(203, 203, 203);">
                  <td style="text-align:left">Sensor Data</td>
                  <td style="text-align:left">Biomarker</td>
                  <td style="text-align:left">Weight</td>
                  <td style="text-align:left">Body Composition Scale</td>
                </tr>
                <tr style="border-bottom: 1px solid rgb(203, 203, 203);">
                  <td style="text-align:left"></td>
                  <td style="text-align:left">Biomarker</td>
                  <td style="text-align:left">Body fat %</td>
                  <td style="text-align:left">Body Composition Scale</td>
                </tr>
                <tr style="border-bottom: 1px solid rgb(203, 203, 203);">
                  <td style="text-align:left"></td>
                  <td style="text-align:left">Biomarker</td>
                  <td style="text-align:left">Subcutaneous fat %</td>
                  <td style="text-align:left">Body Composition Scale</td>
                </tr>
                <tr style="border-bottom: 1px solid rgb(203, 203, 203);">
                  <td style="text-align:left"></td>
                  <td style="text-align:left">Biomarker</td>
                  <td style="text-align:left">Visceral fat %</td>
                  <td style="text-align:left">Body Composition Scale</td>
                </tr>
                <tr style="border-bottom: 1px solid rgb(203, 203, 203);">
                  <td style="text-align:left"></td>
                  <td style="text-align:left">Biomarker</td>
                  <td style="text-align:left">Body water %</td>
                  <td style="text-align:left">Body Composition Scale</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>


      <div id="P-0006">
        <div class="tab-group">
          <button type="button" class="inde">독립</button>
          <button type="button" class="all">전체</button>

          <!-- 독립 -->
          <div class="tab-inde visible">
            <div>
              <dl class="claim-container">
                <div class="root-claim-wrapper">
                  <div class="independent-claim-wrapper">
                    <div class="independent-claim-title">
                      <div class="btn-toggle-more-text plus">
                        <em class="claim-number claim-number-1">
                          [청구항 1]
                        </em>
                      </div>
                      <em class="independent-badge ml-5 mr-5">독</em>
                      <div id="TOOLTIP_INDEPENDENT_CLAIM_wrapper" class="tooltip-wrapper undefined">
                        <div class="btn-tooltip-question"></div>
                        <div id="TOOLTIP_INDEPENDENT_CLAIM" class="tooltip undefined bottom-left tooltip-yellow " style="width: 330px;">
                          <span>로직에 의해</span>
                        </div>
                      </div>
                    </div>
                    <div class="independent-claim-content">
                      <span class="pb-10" style="display: inline-block;">
                        <span>
                          <p id="CLM-0001" type="CLAIM">제1방향으로 배치된 게이트라인들과 제2방향으로 배치된 데이터라인들이 표시패널.<br>
                          </p>
                        </span>
                      </span>

                      <span> <!-- 추가 -->
                        <div class="independent-claim-wrapper pl-20">
                          <div class="independent-claim-title">
                            <em class="claim-number claim-number-2">
                              [청구항 2]
                            </em>
                          </div>
                          <div class="independent-claim-content">
                            <span>
                              <p id="CLM-0002" type="CLAIM">제1항에 있어서,<br>상기 적어도 하나의 차단전극과 전기적으로 연결된 표시패널.<br>
                              </p>
                            </span>
                          </div>
                        </div>
                      </span>

                    </div>
                  </div>
                </div>
              </dl>
            </div>
          </div>

          <!-- 전체 -->
          <div class="tab-all">
            <div>
              <dl class="claim-container">
                <div class="root-claim-wrapper">
                  <div class="independent-claim-wrapper">
                    <div class="independent-claim-title">
                      <em class="claim-number claim-number-1">
                        [청구항 1]
                      </em>
                      <em class="independent-badge ml-5 mr-5">독</em>
                      <div id="TOOLTIP_INDEPENDENT_CLAIM_wrapper" class="tooltip-wrapper undefined">
                        <div class="btn-tooltip-question"></div>
                        <div id="TOOLTIP_INDEPENDENT_CLAIM" class="tooltip undefined bottom-left tooltip-yellow " style="width: 330px;">
                          <span>로직에 의해</span>
                        </div>
                      </div>
                    </div>
                    <div class="independent-claim-content">
                      <span class="pb-10" style="display: inline-block;">
                        <span>
                          <p id="CLM-0001" type="CLAIM">제1방향으로 배치된 게이트라인들과 제2방향으로 배치된 데이터라인들이 표시패널.<br>
                          </p>
                        </span>
                      </span>
                    </div>
                  </div>
                  <div class="independent-claim-wrapper">
                    <div class="independent-claim-title">
                      <em class="claim-number claim-number-2">
                        [청구항 2]
                      </em>
                    </div>
                    <div class="independent-claim-content">
                      <span class="false" style="display: inline-block;">
                        <span>
                          <p id="CLM-0002" type="CLAIM">제1항에 있어서,<br>상기 적어도 하나의 차단전극과 전기적으로 연결된 표시패널.<br>
                          </p>
                        </span>
                      </span>
                    </div>
                  </div>
                </div>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- <div id="memo-toggle">
      <i class="fa-solid fa-note-sticky"></i>
    </div> -->

    <div id="memo-main">
      <div id="memo-tool-bar">
        <div id="memo-search">
          <input type="text" placeholder="검색어 입력">
          <button type="button">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </div>


        <div id="memo-main-close">
          <i class="fa-solid fa-xmark"></i>
        </div>
      </div>

      <!-- <div id="memo-content">
        <div class="memo-content-item"></div>
        <div class="memo-content-item"></div>
        <div class="memo-content-item"></div>
        <div class="memo-content-item"></div>
        <div class="memo-content-item"></div>
        <div class="memo-content-item"></div>
        <div class="memo-content-item"></div>
      </div> -->
    </div>

    <div id="memo-modal" class="modal">
      <div class="modal-content">
        <textarea
          class="memo-input"
          placeholder="메모를 입력해주세요."
          maxlength="100"
        ></textarea>
        <div class="text-notice">0/100</div>
        <button class="save-btn" type="button">저장</button>
        <button class="cancel-btn" type="button">취소</button>
      </div>
    </div>

    <div id="memo-popup">
      <button type="button" class="add">추가</button>
      <button type="button" class="update">수정</button>
      <button type="button" class="remove">삭제</button>
    </div>

    <div id="memo-view"></div>
    <script>
      /*
       * 현재 제한 사항
       * 1. 메모가 중복될 수 없음
       * 2. 메모가 현재 문단을 벗어 날 수 없음
       * 3. 드래그한 대상은 2글자 이상일때만 메모 제공
       * 4. 메모에 이미지가 포함될 수 없음
       * 5. 수정 시에 범위 변경 가능한지 여부에 따라 수정 범위 달라짐
       */
      window.onload = () => {
        const memo = new Memo({ documentId: 'test', containerId: 'container' });
      };
      const indeBtn = document.querySelector('#P-0006 button.inde');
      const allBtn = document.querySelector('#P-0006 button.all');

      const area1 = document.querySelector('.tab-inde');
      const area2 = document.querySelector('.tab-all');
      
      indeBtn.addEventListener('click', event => {
        area1.classList.add('visible');
        area2.classList.remove('visible');
      });

      allBtn.addEventListener('click', () => {
        area1.classList.remove('visible');
        area2.classList.add('visible');
      });

      function Memo({ documentId, containerId }) {
        if (!new.target) {
          throw new Error('Create object using new operator.');
        }

        const COMMON_REGEX          = /\n {2,}/g;
        const MEMO_CLASSNAME        = 'memo';
        const MEMO_ING_CLASSNAME    = 'memo-ing';
        const MEMO_UPDATE_CLASSNAME = 'memo-update';
        const MIN_CHARACTER_LENGTH  = 2;
        const MAX_CHARACTER_LENGTH  = 15000;

        this.isDragging    = false;
        this.isUpdate      = false;
        this.targetMemoKey = 0;

        this.documentId = documentId || '';
        this.$container = document.getElementById(containerId);

        this.storage = JSON.parse(sessionStorage.getItem('data')) || [];

        this.$target       = null;
        this.$parentTarget = null;

        this.selection    = null;
        this.range        = null;
        this.selectedText = null;
        this.prevSelectionRect = null;

        this.pressArrowLeft = false;

        this.$memoView = document.getElementById('memo-view');

        this.$modal          = document.getElementById('memo-modal');
        this.$modalTextarea  = this.$modal.querySelector('textarea.memo-input');
        this.$modalSaveBtn   = this.$modal.querySelector('button.save-btn');
        this.$modalCancelBtn = this.$modal.querySelector('button.cancel-btn');
        this.$modalNotice    = this.$modal.querySelector('div.text-notice');

        this.isPopupHover         = false;
        this.$mousePopup          = document.getElementById('memo-popup');
        this.$mousePopupAddBtn    = this.$mousePopup.querySelector('button.add');
        this.$mousePopupUpdateBtn = this.$mousePopup.querySelector('button.update');
        this.$mousePopupRemoveBtn = this.$mousePopup.querySelector('button.remove');

        this.$memoToggle       = document.getElementById('memo-toggle');
        this.$memoMain         = document.getElementById('memo-main');
        this.$memoMainCloseBtn = document.getElementById('memo-main-close');

        this.groupedData = data => {
          const result = {};

          for (let i = 0, len = data.length; i < len; i++) {
            const item = data[i];
            const { parentSelector } = item;

            if (!result[parentSelector]) {
              result[parentSelector] = [];
            }

            result[parentSelector].push(item);
          }

          return result;
        };

        this.TextByRegex = text => text.replace(COMMON_REGEX, ' ');

        this.createTreeWalker = (element, filter = NodeFilter.SHOW_TEXT) => document.createTreeWalker(element, filter);

        this.removeHighlightElement = (element, memoKey) => {
          let treeWalker = this.createTreeWalker(element);
          let currentNode;
          while (currentNode = treeWalker.nextNode()) {
            const parentNode = currentNode.parentNode;
            const nodeText   = currentNode.nodeValue;

            if (parentNode.getAttribute('memo-key') === memoKey) {
              const targetTextNode = document.createTextNode(nodeText);
              const previousNodeParent = treeWalker.previousNode().parentNode;

              previousNodeParent.replaceChild(targetTextNode, parentNode)
            }
          }
        };

        this.addHighlightElement = (element, start, end, memoKey, classNames = []) => {
          if (end < start) throw new Error('Incorrect data');

          let treeWalker = this.createTreeWalker(element);
          let currentNode;
          while (currentNode = treeWalker.nextNode()) {
            const nodeText       = this.TextByRegex(currentNode.nodeValue);
            const nodeTextLength = nodeText.length;

            if (!nodeText) continue;

            if (start >= nodeTextLength) {
              start -= nodeTextLength;
              end   -= nodeTextLength;
            } else {
              const parentNode = currentNode.parentNode;
              console.log(parentNode)

              const beforeText = nodeText.substring(0, start);
              const targetText = nodeText.substring(start, Math.min(end, nodeTextLength));
              const afterText  = nodeText.substring(Math.min(end, nodeTextLength));

              const beforeTextNode = document.createTextNode(beforeText);
              const targetTextNode = document.createElement('span');
              const afterTextNode  = document.createTextNode(afterText);

              targetTextNode.setAttribute('memo-key', memoKey)
              targetTextNode.textContent = targetText;
              for (const className of classNames) {
                targetTextNode.classList.add(className);
              }

              parentNode.replaceChild(afterTextNode, currentNode);
              parentNode.insertBefore(targetTextNode, afterTextNode);
              parentNode.insertBefore(beforeTextNode, targetTextNode);

              start = 0;
              end  -= targetText.length + beforeText.length;

              if (end <= 0) break;

              treeWalker = this.createTreeWalker(element);
              treeWalker.currentNode = afterTextNode;
            }
          }
        };

        this.loadStorageAndHighlight = () => {
          if (this.storage && this.storage.length) {
            const groupData = this.groupedData(
              this.storage.sort((a, b) => {
                if (a.parentSelector < b.parentSelector) return -1;
                if (a.parentSelector > b.parentSelector) return 1;
                if (a.start > b.start) return -1;
                if (a.start < b.start) return 1;
                return 0;
              })
            );

            for (const groupSelector in groupData) {
              if (groupData[groupSelector]) {
                const items   = groupData[groupSelector];
                const element = document.querySelector(groupSelector);

                for (let i = 0, itemLen = items.length; i < itemLen; i++) {
                  const item = items[i];
                  const { start, end, targetText, memoKey } = item;

                  this.addHighlightElement(element, start, end, memoKey, [ MEMO_CLASSNAME ]);
                }
              }
            }
          }
        };

        this.getNodesWithinRange = range => {
          const nodes = [];
          const treeWalker = this.createTreeWalker(range.commonAncestorContainer, NodeFilter.SHOW_ELEMENT);

          let currentNode;
          while (currentNode = treeWalker.nextNode()) {
            if (range.intersectsNode(currentNode)) {
              nodes.push(currentNode);
            }
          }

          return nodes;
        };

        this.isPossibleMemo = (selection, range) => {
          let possible = true;
          let message  = '';

          const selectionText = selection.toString().trim();


          if (!range.startContainer || !range.startContainer.parentNode.closest(`div[id="${ containerId }"]`) || !range.endContainer.parentNode.closest(`div[id="${ containerId }"]`)) {
            possible = false;
            message  = `Out of range`;
          }

          if (!selectionText || selectionText.length < MIN_CHARACTER_LENGTH) {
            possible = false;
            message  = `Requires least ${ MIN_CHARACTER_LENGTH } characters`;
          }

          if (selectionText.length > MAX_CHARACTER_LENGTH) {
            possible = false;
            message  = `Too many characters`;
          }

          if (possible && document.getElementsByClassName(MEMO_ING_CLASSNAME).length) {
            possible = false;
            message  = 'Already writing memo';
          }

          if (possible) {
            if (range.commonAncestorContainer.parentNode.classList.contains(MEMO_CLASSNAME)) {
              possible = false;
              message  = 'Memo already exists';
            }
          }

          // if (possible) {
          //   const parentTagList = [ 'li', 'p', 'div' ];

          //   const startNode = selection.anchorNode.parentNode.closest(parentTagList.join(','));
          //   const endNode   = selection.focusNode.parentNode.closest(parentTagList.join(','));

          //   if (startNode !== endNode) {
          //     console.log(startNode, endNode)
          //     possible = false;
          //     message  = 'Only available in the same paragraph';
          //   }
          // }

          if (possible) {
            const nodes = this.getNodesWithinRange(range);
            console.log(nodes)

            for (let i = 0, len = nodes.length; i < len; i++) {
              const node = nodes[i];

              console.log(node)
              if (node.classList.contains(MEMO_CLASSNAME)) {
                possible = false;
                message  = 'Memo cannot overlap each other';
                break;
              } else if (node.nodeName === 'BUTTON') {
                possible = false;
                message  = 'Memo cannot includes button';
              } else if (node.nodeName === 'IMG' || (node.nodeName === 'EM' && node.textContent.toUpperCase().trim() === 'IMAGE' )) {
                possible = false;
                message  = 'Memo cannot include img or badge';
              } else if (node.nodeName === 'TR' || node.nodeName === 'TD' || node.nodeName === 'TH') {
                possible = false;
                message  = 'Memo cannot use between table elements';
              }
            }
          }

          return { possible, message };
        };

        this.highlightSelectedTextAndOpenModal = () => {
          if (this.range) {
            this.targetMemoKey = Math.floor(Math.random() * 10_000) + '';
            const preSelectionRange = this.range.cloneRange();

            preSelectionRange.selectNodeContents(this.$parentTarget);
            preSelectionRange.setEnd(this.range.startContainer, this.range.startOffset);

            this.range.start = this.TextByRegex(preSelectionRange.toString()).length;
            this.range.end   = this.range.start + this.TextByRegex(this.range.toString()).length;

            this.addHighlightElement(this.$parentTarget, this.range.start, this.range.end, this.targetMemoKey, [ MEMO_CLASSNAME, MEMO_ING_CLASSNAME ]);

            this.selection.removeAllRanges();

            this.openModal();
          }
        };

        this.openModal = () => {
          this.$modal.style.display = 'block';

          let xAxis = event.pageX;
          let yAxis = event.pageY;

          const modalWidth  = this.$modal.offsetWidth;
          const modalHeight = this.$modal.offsetHeight;

          if (xAxis - modalWidth < 0) {
            xAxis = modalWidth / 2;
          } else if (window.innerWidth < xAxis + modalWidth) {
            xAxis = window.innerWidth - modalWidth;
          }

          if (yAxis + modalHeight > window.innerHeight) {
            if (yAxis - modalHeight > 0) {
              yAxis -= modalHeight * 2;
            } else {
              yAxis = window.innerHeight - modalHeight;
            }
          }

          this.$modal.style.left = `${ xAxis }px`;
          this.$modal.style.top  = `${ yAxis }px`;

          this.$modalTextarea.focus();
        };

        this.hideModal = () => {
          this.$modal.style.display   = 'none';
          this.$modalTextarea.value   = '';
          this.$modalNotice.innerText = '0/100';
        };

        this.setEvent = () => {
          this.setEventModal();
          this.setEventMousePopup();
          this.setEventHighlight();
          this.memoToggleEvent();
        };

        this.showMouseBtnGroup = (groupName = 'ADD') => {
          if (groupName === 'ADD') {
            this.$mousePopupAddBtn.style.display    = 'block';
            this.$mousePopupUpdateBtn.style.display = 'none';
            this.$mousePopupRemoveBtn.style.display = 'none';
          } else {
            this.$mousePopupAddBtn.style.display    = 'none';
            this.$mousePopupUpdateBtn.style.display = 'inline-block';
            this.$mousePopupRemoveBtn.style.display = 'inline-block';
          }
        }

        this.setEventHighlight = () => {
          this.setEventHighlightMemo();
          this.setEventHighlightHover();
        }

        this.setEventHighlightMemo = () => {
          this.$container.addEventListener('click', event => {
            if (event.target.classList.contains(MEMO_CLASSNAME) && !event.target.classList.contains(MEMO_ING_CLASSNAME) && !document.getElementsByClassName(MEMO_ING_CLASSNAME).length) {
              this.$target        = event.target;
              this.$parentTarget  = this.$target.closest('div');
              if (event.target.getAttribute('memo-key')) {
                this.targetMemoKey = event.target.getAttribute('memo-key');
              }

              this.showMouseBtnGroup('UPDATE');
              this.openMousePopup(event);
            }
          });
        }

        this.getElementsSameKey = target => {
          const memoKey = target.getAttribute('memo-key');
          if (memoKey) {
            this.targetMemoKey = memoKey;
          }

          return [ ...this.$container.querySelectorAll(`span[memo-key="${ memoKey }"]`) ];
        }

        this.setEventHighlightHover = () => {
          this.$container.addEventListener('mouseover', ({ target }) => {
            const elements = this.getElementsSameKey(target);

            if (elements.length) {
              for (const element of elements) {
                element.classList.add('memo-hover');
              }

              const data = this.storage.find(item => item.memoKey === this.targetMemoKey);

              if (data) {
                this.$memoView.style.display = 'block';

                let xAxis = event.x;
                let yAxis = event.y;

                const memoViewWidth  = this.$memoView.offsetWidth;
                const memoViewHeight = this.$memoView.offsetHeight;

                if (xAxis - memoViewWidth < 0) {
                  xAxis = 10;
                } else if (window.innerWidth < xAxis + memoViewWidth) {
                  xAxis = window.innerWidth - memoViewWidth * 1.1;
                }

                yAxis -= memoViewHeight * 1.2;
                if (yAxis < 0) {
                  yAxis = memoViewHeight;
                }

                this.$memoView.style.left = `${ xAxis }px`;
                this.$memoView.style.top  = `${ yAxis }px`;
                this.$memoView.innerText  = data.memoText;
              }
            }
          });
          this.$container.addEventListener('mouseout', ({ target }) => {
            const elements = this.getElementsSameKey(target);

            if (elements.length) {
              for (const element of elements) {
                element.classList.remove('memo-hover');
              }
            }

            this.$memoView.style.display = 'none';
          });
        }

        this.setEventModal = () => {
          this.setEventTextarea();
          this.setEventSaveButton();
          this.setEventCancelButton();
        }

        this.setEventTextarea = () => {
          this.$modalTextarea.addEventListener('keydown', event => event.keyCode === 13 && event.preventDefault());
          this.$modalTextarea.addEventListener('keyup', () => this.$modalNotice.innerText = `${ this.$modalTextarea.value.length || 0 }/100`);
        };

        this.setEventSaveButton = () => {
          this.$modalSaveBtn.addEventListener('click', () => {
            const memoText = this.$modalTextarea.value;

            if (memoText.trim().length === 0) {
              return window.alert('메모 입력되지 않음');
            }

            if (this.$target) {
              for (const ingTag of [ ...this.$parentTarget.getElementsByClassName(MEMO_ING_CLASSNAME) ]) {
                ingTag.classList.remove(MEMO_ING_CLASSNAME);
              }

              if (this.isUpdate) {
                let data = this.storage.find(item => item.memoKey === this.targetMemoKey);
                data = {
                  ...data,
                  memoText
                };

                this.storage = this.storage.filter(item => item.memoKey !== this.targetMemoKey);
                this.storage.push(data);

                const elements = this.getElementsSameKey(this.$target);

                if (elements.length) {
                  for (const element of elements) {
                    element.classList.remove(MEMO_UPDATE_CLASSNAME);
                  }
                }

                this.isUpdate = false;
                window.alert('수정되었습니다.');
              } else {
                this.storage.push({
                  documentId    : this.documentId,
                  parentSelector: this.getSelectorPath(this.$parentTarget),
                  targetText    : this.selectedText,
                  start         : this.range.start,
                  end           : this.range.end,
                  memoKey       : this.targetMemoKey,
                  memoText,
                });

                console.log(this.selectedText, this.range.start, this.range.end)
                window.alert('저장되었습니다.');
              }

              sessionStorage.setItem('data', JSON.stringify(this.storage));
            }

            this.hideModal();
          });
        };

        this.setEventCancelButton = () => {
          this.$modalCancelBtn.addEventListener('click', () => {
            if (this.$parentTarget) {
              if (!this.isUpdate) {
                this.removeHighlightElement(this.$parentTarget, this.targetMemoKey);
              } else {
                const elements = this.getElementsSameKey(this.$target);

                if (elements.length) {
                  for (const element of elements) {
                    element.classList.remove(MEMO_UPDATE_CLASSNAME);
                  }
                }

                this.isUpdate = false;
              }

              this.hideModal();
            }
          });
        };

        this.calMousePopupLocatoin = event => {
          let xAxis = undefined;
          let yAxis = undefined;

          const rect = this.range.getBoundingClientRect();
          if (event.type === 'keyup' || event.type === 'keydown') {
            if (rect.top !== this.prevSelectionRect.top) {
              yAxis = window.scrollY + rect.top;
            } else if (rect.bottom !== this.prevSelectionRect.bottom) {
              yAxis = window.scrollY + rect.bottom;
            }

            if (event.keyCode === 37) {
              xAxis = Number(this.$mousePopup.style.left.split('px')[0]) - 7;
            } else if (event.keyCode === 39) {
              xAxis = Number(this.$mousePopup.style.left.split('px')[0]) + 7;
            }
          } else {
            xAxis = event.pageX;
            yAxis = event.pageY;

            const popupWidth  = this.$mousePopup.offsetWidth;
            const popupHeight = this.$mousePopup.offsetHeight;

            if (xAxis - popupWidth < 0) {
              xAxis = popupWidth / 1.5;
            } else if (window.innerWidth < xAxis + popupWidth * 2) {
              xAxis = window.innerWidth - popupWidth * 1.5
            }
          }

          this.prevSelectionRect = rect;

          this.$mousePopup.style.left = `${ xAxis }px`;
          this.$mousePopup.style.top  = `${ yAxis }px`;
        }

        this.openMousePopup = event => {
          this.calMousePopupLocatoin(event);

          this.$mousePopup.style.display = 'block';
        };

        this.closeMousePopup = () => {
          this.$mousePopup.style.display = 'none';
        }

        this.setEventMousePopup = () => {
          this.$mousePopup.addEventListener('mouseover', () => this.isPopupHover = true);
          this.$mousePopup.addEventListener('mouseout', () => this.isPopupHover = false);

          this.$mousePopupAddBtn.addEventListener('click', () => {
            this.$mousePopup.style.display = 'none';

            this.highlightSelectedTextAndOpenModal();
          });

          this.$mousePopupUpdateBtn.addEventListener('click', () => {
            this.$mousePopup.style.display = 'none';

            const elements = this.getElementsSameKey(this.$target);

            if (elements.length) {
              for (const element of elements) {
                element.classList.add(MEMO_UPDATE_CLASSNAME);
              }
            }

            const data = this.storage.find(item => item.memoKey === this.targetMemoKey);

            if (data) {
              this.isUpdate = true;
              this.$modalTextarea.value = data.memoText;
              this.$modalNotice.innerText = `${ data.memoText.length || 0 }/100`;
            }

            this.openModal();
          });

          this.$mousePopupRemoveBtn.addEventListener('click', () => {
            if (window.confirm('정말 삭제하시겠습니까?')) {
              this.removeHighlightElement(this.$container, this.targetMemoKey);

              this.storage = this.storage.filter(item => item.memoKey !== this.targetMemoKey);
              sessionStorage.setItem('data', JSON.stringify(this.storage));

              this.$mousePopup.style.display = 'none';
            }
          });

          document.addEventListener('mousedown', () => {
            if (!this.isPopupHover) {
              this.$mousePopup.style.display = 'none';
            }
          });
        };

        this.getSelectorPath = element => {
          if (!(element instanceof Element)) return;

          let path = [];
          while (element.nodeType === Node.ELEMENT_NODE) {
            let selector = element.nodeName.toLowerCase();
            if (element.id) {
              selector += `#${ element.id }`;
            } else if (element.getAttribute('num')) {
              selector += `[num="${ element.getAttribute('num') }"]`
            } else if (element.getAttribute('key')) {
              selector += `[key="${ element.getAttribute('key') }"]`
            } else if (targetClass && element.classList.contains(targetClass)) {
              selector += `.${targetClass}`;
              path.unshift(selector);
              break;
            }
            // else  {
            //   let sibling = element, nth = 1;
            //   while (sibling.nodeType === Node.ELEMENT_NODE && (sibling = sibling.previousSibling) && nth++) {
            //     selector += `:nth-child(${ nth })`;
            //   }
            // }
            path.unshift(selector);

            if (element.id) break;
            element = element.parentNode;
          }

          return path.join(' > ');
        };

        this.memoToggleEvent = () => {
          this.$memoToggle.addEventListener('click', () => {
            const right = this.$memoMain.style.right;
            if (right === '15px') {
              this.$memoMain.style.right = '-50%';
            } else {
              this.$memoMain.style.right = '15px';
            }
          });
          this.$memoMainCloseBtn.addEventListener('click', () => {
            this.$memoMain.style.right = '-50%';
          });
        }

        this.getTextSelection = event => {
          if (this.isDragging) return this.closeMousePopup();

          const selection = window.getSelection();
          const range     = selection.rangeCount && selection.getRangeAt(0);

          console.log(selection, range)
          const { possible, message } = this.isPossibleMemo(selection, range);

          if (!possible) {
            this.closeMousePopup();
            console.error(message);
          } else {
            this.$target = event.target;
            if (event.type !== 'mouseup') {
              this.$target = range.endContainer.parentNode;
            }

            this.$parentTarget = range.commonAncestorContainer;
            if (this.$parentTarget.nodeType === 3) {
              this.$parentTarget = this.$parentTarget.parentNode;
            }

            this.selection    = selection;
            this.selectedText = this.selection.toString();
            this.range        = this.selection.getRangeAt(0);

            this.showMouseBtnGroup('ADD');
            this.openMousePopup(event);
          }
        }

        this.init = () => {
          this.loadStorageAndHighlight();

          this.$container.addEventListener('mousedown', () => this.isDragging = false);
          this.$container.addEventListener('mousemove', event => {
            if (event.buttons === 1) {
              this.isDragging = true;
            }
          });

          window.document.addEventListener('keydown', event => { 
            const arrowKeys = [37, 38, 39, 40]; // 37: left, 38: up, 39: right, 40: down

            if (event.shiftKey) {
              if (arrowKeys.includes(event.keyCode)) {
                this.isDragging = true;

                this.calMousePopupLocatoin(event);
              }
            }
          })

          window.document.addEventListener('keyup', event => {
            const arrowKeys = [37, 38, 39, 40]; // 37: left, 38: up, 39: right, 40: down

            if (event.shiftKey) {
              if (arrowKeys.includes(event.keyCode)) {
                this.isDragging = false;

                this.getTextSelection(event);
              }
            }
          });

          this.$container.addEventListener('mouseup', event => {
            this.isDragging = false;
            this.getTextSelection(event);
          });

          this.setEvent();
        };

        this.init();
      }
    </script>
  </body>
</html>
