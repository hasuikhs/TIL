# 21. 로깅과 사용 추적

## 21.1 로그란 무엇인가?

- 로깅을 하는 이유
  - 서버나 프락시의 문제 찾기 위함
  - 웹 사이트 접근 통계를 내리기 위함
- HTTP 트랜젝션의 모든 헤더를 로깅 가능하지만, 하루에 수없이 많은 트래픽을 처리하는 서버나 프락시에서 로깅은 감당 불가
- HTTP 메서드와 URL은 어떤 요청이 어떤 일을 하려고 했는지 가리킴
- 버전 정보는 클라이언트와 서버 간에 문제가 생겼을 때 디버깅하는데 도움이 될 클라이언트와 서버 정보 제공
- HTTP 상태 코드는 요청의 처리 상태 정보 제공
- 요청/응답 크기와 타임스탬프는 주로 계측하는데 사용

## 21.2 로그 포맷

- 상용 혹은 오픈 소스 HTTP 애플리케이션은 대부분, 표준 로그 포맷을 한 개 이상 지원
- 애플리케이션 대부분이 로그 포맷을 설정하고 자체 맞춤 포맷을 만들 수 있는 설정 기능 제공

### 21.2.1 일반 로그 포맷

- NCSA가 정의했고, 많은 서버가 이 로그 포맷을 기본으로 사용

- 일반 로그 포맷의 필드

  | 필드          | 설명                                                         |
  | ------------- | ------------------------------------------------------------ |
  | remotehost    | 요청한 컴퓨터의 호스트명 혹은 IP 주소                        |
  | username      | ident 검색을 수행했다면, 인증된 요청자의 사용자 이름 존재    |
  | auth-username | 인증을 수행했다면, 인증된 요청자의 이름 존재                 |
  | timestamp     | 요청 날짜와 시간                                             |
  | request-line  | HTTP 요청의 행을 그대로 기술                                 |
  | response-code | 응답으로 보내는 HTTP 상태 코드                               |
  | response-size | 응답 엔터티의 Content-Length, 응답으로 반환값이 없으면 값이 0 |

### 21.2.2 혼합 로그 포맷

- 혼합 로그 포맷은 일반 로그 포맷에 추가된 필드 두개를 제외하면 똑같음

  | 필드       | 설명                              |
  | ---------- | --------------------------------- |
  | Referer    | Referrer HTTP 헤더 값             |
  | User-Agent | User-Agent Referer HTTP 헤더의 값 |

### 21.2.3 넷스케이프 확장 로그 포맷

- 넷스케이프의 포맷은 프락시나 웹 캐시 같은 HTTP 애플리케이션과 연관이 있는 여러 환경을 지원하려고 포맷을 확장

- 넷스케이프 확장 로그 포멧은 일반 로그 포맷에 다음의 필드들 추가

  | 필드                     | 설명                                                         |
  | ------------------------ | ------------------------------------------------------------ |
  | proxy-response-code      | 트랜잭션이 프락시를 거칠 경우, 서버에서 프락시로의 HTTP 응답 코드 |
  | proxy-response-size      | 트랜잭션이 프락시를 거칠 경우, 서버가 프락시에 전달하는 응답 엔터티의 Content-Length |
  | client-request-size      | 클라이언트가 프락시로 보내는 요청의 본문이나 엔터티의 Content-Length |
  | proxy-request-size       | 트랜잭션이 프락시를 거칠 경우, <br>프락시가 서버로 보내는 요청의 본문이나 엔터티의 Content-Length |
  | client-request-hdr-size  | 클라이언트 요청 헤더의 바이트 길이                           |
  | proxy-response-hdr-size  | 트랜잭션이 프락시를 거칠 경우, 프락시가 요청자에게 보내는 응답 헤더의 바이트 길이 |
  | proxy-request-hdr-size   | 트랜잭션이 프락시를 거칠 경우, 프락시가 서버로 전송하는 요청 헤더의 바이트 길이 |
  | server-response-hdr-size | 서버 응답 헤더의 바이트 길이                                 |
  | proxy-timestamp          | 트랜잭션이 프락시를 거칠 경우, 요청과 응답이 프락시를 통해 오가는 총 시간(초) |

### 21.2.4 넷스케이프 확장 2 로그 포맷

- 넷스케이프 확장 로그 포맷에서 다음의 필드들 추가

  | 필드                      | 설명                                                         |
  | ------------------------- | ------------------------------------------------------------ |
  | route                     | 프락시가 클라이언트에 요청을 만드는데 사용하는 경로          |
  | client-finish-status-code | 클라이언트의 종료 상태 코드로, <br>클라이언트가 프락시로 보낸 요청이 성공적으로 완료(FIN) 되었는지, 인터럽트에 걸렸는지(INTR) |
  | proxy-finish-status-code  | 프락시의 종료 코드로, <br>프락시가 서버로 보낸 요청이 성공적으로 완료(FIN) 되었는지, 인터럽트에 걸렸는지(INTR) |
  | cache-result-code         | 캐시 결과 코드로, 캐시가 요청에 어떻게 응답했는지 기술       |

- 넷스케이프 애플리케이션은, 다른 많은 HTTP 애플리케이션과 마찬가지로 출력될 로그의 포맷을, 관리자가 수정 가능한 유연한 로그 포맷을 포함한 다양한 로그 포맷을 가짐

- 이런 포맷이 있기 때문에 관리자는 추가적인 설정을 해서 로그에 기록할 HTTP 트랜잭션의  특정 부분을 선택하여 로그 최적화 가능

- 관리자가 포맷을 기호에 맞게 수정 가능하도록 하는 기능이 추가된 것은, 로그에서 얻을 수 있는 정보 중에서 어떤 것을 필요로 하는지 예측하기 어렵기 때문

- 다른 많은 프락시오 ㅏ서버 역시 로그에서 특정 정보만 추출하는 기능 제공

### 21.2.5 스퀴드(Squid) 프락시 로그 포맷

- 스퀴드는 수년간 오픈 소스 커뮤니티를 통해 확장 및 개선되어 온 프로젝트

- 스퀴드 애플리케이션을 관리하는 데 도움이 되는 수많은 도구들이 개발됨

- 로그 엔트리 포맷

  | 필드               | 설명                                                         |
  | ------------------ | ------------------------------------------------------------ |
  | timestamp          | 요청이 도착한 시간을 리눅스 초로 기술(초 단위)               |
  | time-elapsed       | 요청과 응답이 프락시를 토앻 오고간 총 시간을 밀리초로 기술   |
  | host-ip            | 클라이언트의 호스트 장비 IP 주소                             |
  | result-code/status | result 필드에는 이 요청에 프락시가 어떤 일을 했는지 스퀴드 방식으로 기술<br>code 필드는 프락시가 클라이언트에 보낸 HTTP 응답 코드 |
  | size               | 프락시가 클라이언트에게 보낸 HTTP 응답 헤더와 본문을 포함한 응답의 길이가 바이트 단위로 기술 |
  | method             | 클라이언트 요청의 HTTP 메서드                                |
  | url                | 클라이언트 요청의 URL                                        |
  | rfc931-ident       | 클라이언트에 인증된 사용자 이름                              |
  | hierarchy/from     | 넷스케이프 포맷에 있는 경로(route) 필드 길이, hierarchy 필드에는 프락시가 클라이언트로 요청을 보내면서 거친 경로를 기술 |
  | content-type       | 프락시 응답 엔터티의 Content-Type                            |

  

