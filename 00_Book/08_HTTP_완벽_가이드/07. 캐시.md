# 7. 캐시

> - 웹 캐시는 자주 쓰이는 문서의 사본을 자동으로 보관하는 HTTP 장치

## 7.1 불필요한 데이터 전송

- 복수의 클라이언트가 자주 쓰이는 원 서버 페이지에 접근할 때, 서버는 같은 문서를 클라이언트에 각각 한 번씩 전송
- 이 때 같은 바이트들이 네트워크를 계속 반복해서 이동하면 값비싼 네트워크 대역폭을 잡아먹어 부하를 줌
- **캐시를 이용하면, 서버 응답은 캐시에 보관되어, 중복해서 트래픽을 주고받는 낭비가 줄어듬**

## 7.2 대역폭 병목

- 캐시는 네트워크 병목을 줄여줌
- 네트워크는 원 격서버보다 로컬 네트워크 클라이언트에 더 넓은 대역폭 제공
- 클라이언트들이 서버에 접근할 때의 속도는, 그 경로에 있는 가장 느린 네트워크 속도와 같음

## 7.3 갑작스런 요청 쇄도(Flash Crowds)

- 갑작스런 사건으로 인해 트래픽이 급증하는 경우는 네트워크와 웹 서버의 심각한 장애를 야기

## 7.4 거리로 인한 지연

- 대역폭뿐아니라 거리로 인해 문제가 될 수 있음
- 모든 네트워크 라우터는 제각각 인터넷 트래픽을 지연
- CDN의 등장? **CDN은 캐싱을 수행하지만, 캐싱은 CDN이 아님**

## 7.5 적중과 부적중

- 캐시 적중
  - 캐시에 요청이 도착했을 때, 만약 그에 대응하는 사본이 있다면 그를 이용해 요청을 처리
- 캐시 부적중
  - 만약 대응하는 사본이 없다면 그냥 원서버로 전달

### 7.5.1 재검사

- 원 서버 콘텐츠는 변경 가능하기에, 캐시는 반드시 그들이 갖고 있는 사본이 여전히 최신인지를 때때로 점검
- 캐시는 스스로 원한다면 언제든지 사본 재검사 가능, 단 충분히 오래된 경우에만 재검사를 함
- 콘텐츠가 변경되지 않았다면, 서버는 아주 작은 304 Not Modified 응답을 보냄
- 사본의 유효함을 알게 된 캐시는 즉각 사본이 최신이라고 임시로 다시 표시한 후 사본을 클라이언트에 제공

### 7.5.2 적중률

- 캐시가 요청을 처리하는 비율
- 적중률은 예측하기 어렵지만 오늘날 적중률 40%면 웹 캐시로 괜찮음

### 7.5.3 바이트 적중률

- 문서들이 모두 같은 크기인 것은 아니기에 문서 적중률이 모든 것을 말해주지는 않음
- 몇몇 큰 객체는 덜 접근되지만 그 크기 때문에 전체 트래픽에는 더 크게 기여하기 때문에 사용

### 7.5.4 적중과 부적중의 구별

- HTTP는 클라이언트에게 응답이 캐시 적중이었는지 아니면 원 서버 접근인지 말해줄 수 있는 방법을 제공하지 않음
- 응답이 캐시에서 왔는지 알아내는 한 가지 방법은 Date 헤더를 이용
  - 응답의 Date 헤더 값을 현재 시각과 비교하여 응답의 생성일이 더 오래 되었다면 응답이 캐시된 것을 확인 가능
- 또 다른 방법은 응답이 얼마나 오래되었는지 말해주는 Age 헤더를 이용

## 7.6 캐시 토폴로지

### 7.6.1 개인 전용 캐시

- 많은 에너지나 저장 공간을 필요로 하지 않아 작고 저렴함

- 웹브라우저는 개인 전용 캐시 내장하고 있고, 사용자가 캐시 사이즈와 설정을 수정 가능하게 허용

### 7.6.2 공용 프락시 캐시

- 공용 캐시는 캐시 프락시 서버 혹은 프락시 캐시라고 불리는 특별한 종류의 공유된 프락시 서버
- 공용 캐시에는 여러 사용자가 접근하기 때문에, 불필요한 트래픽을 줄일 수 있는 더 많은 기회 존재

### 7.6.3 프락시 캐시 계층들

- 작은 캐시에서 캐시 부적중이 발생했을 때 더 큰 부모 캐시가 남겨진 트래픽을 처리하도록 만드는 것이 더 합리적
- 클라이언트 주변에는 작은 캐시를 배치하고 상위에는 많이 공유되는 더 크고 강력한 캐시를 사용
- **캐시의 계층이 깊다면, 프락시 연쇄가 길어지고 각 중간 프락시는 현저한 성능 저하 유발 가능**

## 7.7 캐시 처리 단계

1. **요청 받기** : 캐시는 네트워크로부터 도착한 요청 메시지를 읽음
2. **파싱** : 캐시는 메시지를 파싱하여 URL과 헤더들을 추출
3. **검색** : 캐시는 로컬 복사본이 있는지 검사하고, 없다면 사본을 받아와 로컬에 저장
4. **신선도 검사** : 캐시는 캐시된 사본이 충분히 최신인지 검사하고, 아니라면 변경사항이 있는지 서버에 요청
5. **응답 생성** : 캐시는 새로운 헤더와 캐시된 본문으로 응답 메시지를 만듦
6. **발송** : 캐시는 네트워크를 통해 응답을 클라이언트에게 돌려줌
7. **로깅** : 선택적으로, 캐시는 로그파일에 트랜잭션에 대해 서술한 로그 하나를 남김