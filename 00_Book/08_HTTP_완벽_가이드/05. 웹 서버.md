# 5. 웹 서버

## 5.1 다채로운 웹 서버

- 웹 서버는 웹 서버 소프트웨어와 웹페이지 제공에 특화된 장비 양쪽 모두를 가리킴
- 모든 웹 서버는 리소스에 대한 HTTP 요청을 받아서 콘텐츠를 클라이언트에 돌려줌

### 5.1.1 웹 서버 구현

- 웹 서버는 리소스를 관리하고 웹 서버를 설정, 통제, 확장하기 위한 관리 기능 제공
- 웹 서버는 TCP 커넥션 관리에 대한 책임을 OS와 나눠 갖음
- OS는 시스템의 하드웨어를 관리하고 TCP/IP 네트워크 지원, 파일 시스템, 프로세스 관리 제공

### 5.1.2 다목적 소프트웨어 웹 서버

- 네트워크에 연결된 표준 컴퓨터 컴퓨터 시스템에서 동작
- 거의 모든 컴퓨터와 운영체제에서 동작

### 5.1.3 임베디드 웹 서버

- 일반 소비자용 제품에 내장 목적으로 만들어진 작은 웹 서버
- 소비자용 기기를 간편한 웹 브라우저 인터페이스로 관리 가능케 해줌
- 보통 최소한의 기능만 제공

## 5.2 웹 서버 작업 순서

### 5.2.1 클라이언트 커넥션 수락

- 웹 서버는 어떤 커넥션이든 마음대로 거절하거나 즉시 닫기 가능
- 클라이언트의 IP 주소나 호스트 명이 인가되지 않았거나 악의적이라고 알려진 커넥션을 닫음
- 대부분의 웹 서버는 '역방향 DNS'를 사용해서 클라이언트의 IP 주소를 클라이언트의 호스트 명으로 변환
- 웹 서버는 클라이언트 호스트 명을 구체적인 접근 제어와 로깅을 위해 사용 가능
- 호스트 명 룩업은, 웹 트랜젝션 속도 저하 가능

### 5.2.2 요청 메시지 수신

- 커넥션에 데이터가 도착하면, 웹 서버는 네트워크 커넥션에서 데이터를 읽고 파싱하여 요청 메시지 구성
- 몇몇 웹 서버는 요청을 쉽게 다룰 수 있도록 내부 자료 구조에 저장
- 고성능 웹 서버는 수천 개의 커넥션을 여는 것을 지원
  - 단일 스레드 웹 서버
    - 한 번에 하나씩 요청 처리
    - **처리 도중 모든 다른 커넥션은 무시되어, 심각한 성능 문제 발생**
    - 로드가 적은 서버나 type-o-serve 같은 진단도구에 적당
  - 멀티 프로세스와 멀티 스레드 웹 서버
    - 여러 요청을 동시에 처리
    - 몇몇 서버는 매 커넥션마다 스레드/프로세스 하나를 할당
    - **수많은 동시 커넥션을 처리에 많은 리소스를 소비하므로 최대 스레드/프로세스에 제한을 둠**
  - 다중 I/O 서버
    - 대량의 커넥션을 지원하기 위해, 많은 웹 서버는 다중 아키텍처를 채택
    - 다중 아키텍처에서 모든 커넥션은 동시에 그 활동을 감시 당함
    - 커넥션의 상태가 바뀌면 해당 커넥션에 대해 작은 양의 처리가 수행
    - 처리가 완료되면, 커넥션은 다음번 상태 변경을 위해 열린 커넥션 목록으로 돌아감
    - 커넥션에 대해 작업을 수행하는 것은 일이 있을 때뿐여서 기다림에 리소스를 낭비하지 않음
  - 다중 멀티스레드 웹 서버
    - CPU 여러 개의 이점을 살리기 위해 멀티스레딩과 다중화를 결합
    - 여러 개의 스레드는 가각 열려있는 커넥션을 감시하고 각 커넥션에 대해 조금씩 작업
    - 다중 I/O 서버를 여러개 합쳐놓은 형태

### 5.2.3 요청 처리

### 5.2.4 리소스의 매핑과 접근

- Docroot
  - 요청 URI를 웹 서버의 파일 시스템 안에 있는 파일 이름으로 사용하는 것
  - 가상 호스팅 docroot
    - 각 사이트에 분리된 문서 루트를 주는 방법
  - 사용자 홈 디렉토리 docroots
    - 사용자들이 한 대의 웹 서버에서 각자의 개인 웹 사이트를 만들 수 있도록 해주는 것
- 디렉토리 목록
  - 경로가 파일이 아닌 디렉토리를 가리키는, 디렉토리 URL에 대한 요청을 받을 수 있음
- 동적 콘텐츠 리소스 매핑
  - URI를 동적 리소스에 매핑 가능
  - 대부분의 웹 서버는 동적 리소스를 식별하고 매핑할 수 있는 기본적인 매커니즘을 가짐
- 서버사이드 인클루드(Server-Side Includes, SSI)
- 접근 제어

### 5.2.5 응답 만들기

- 서버가 리소스를 식별하면, 서버는 요청으로 서술되는 동작을 수행한 뒤 응답 반환
- 응답은 응답 상태 코드, 응답 헤더, 응답 본문을 포함

### 5.2.6 응답 보내기

- 서버는 여러 클라이언트에 대한 많은 커넥션을 가질 수 있음
- 각각 커넥션은 일을 할 수도 대기하고 있을 수 있음
- 서버는 커넥션 상태를 추적
  - 지속적 커넥션
    - 특별히 주의해서 다뤄야 함
    - 클라이언트가 응답이 언제 끝나는지 알 수 없는 경우 커넥션은 열린 상태를 유지
  - 비지속적인 커넥션은 모든 메시지를 전송했을 때 닫힐 수 있음

### 5.2.7 로깅

- 트랜젝션이 완료되었을 경우 웹 서버는 트랜젝션의 수행 결과를 로그 파일에 기록

