# 11. 클라이언트 식별과 쿠키

## 11.1 개별 접촉

- HTTP는 익명으로 사용하며 상태가 없고 요청과 응답으로 통신하는 프로토콜
- 현대의 웹 사이트들은 개인화된 서비스를 제공하고 싶어함
  - **개별 인사**
  - **사용자 맞춤 추천**
  - **저장된 사용자 정보**
  - **세션 추적**

## 11.2 HTTP 헤더

| 헤더 이름       | 헤더 타입  | 설명                                     |
| --------------- | ---------- | ---------------------------------------- |
| From            | 요청       | 사용자의 이메일 주소                     |
| User-Agent      | 요청       | 사용자의 브라우저                        |
| Referer         | 요청       | 사용자가 현재 링크를 타고 온 근원 페이지 |
| Authorization   | 요청       | 사용자 이름과 비밀번호                   |
| Client-ip       | 확장(요청) | 클라이언트의 IP 주소                     |
| X-Forwarded-For | 확장(요청) | 클라이언트의 IP 주소                     |
| Cookie          | 확장(요청) | 서버가 생성한 ID 라벨                    |

## 11.3 클라이언트 IP 주소

- 클라이언트의 IP 주소는 보통 HTTP 헤더에 없지만 웹 서버는 HTTP 요청을 보내ㅅ는 반대쪽 TCP 커넥션의 IP 주소를 알아냄
- **클라이언트 IP 주소로 사용자를 식별하는 방식은 다음의 약점을 가짐**
  - 클라이언트 IP는 사용자가 아닌, 사용하는 컴퓨터를 가리킴, 여러 사용자가 같은 컴퓨터를 사용하면 식별 불가
  - 인터넷 서비스 제공자는 사용자가 로그인하면 동적으로 IP 주소를 할당, 웹 서버는 사용자를 IP 주소로 식별 불가
  - 보안을 강화하기 위해 만흔 사용자가 네트워크 주소 변환(NAT) 사용
    - NAT 장비들은 클라이언트의 실제 IP 주소를 방화벽 뒤로 숨김
    - 클라이언트의 실제 IP 주소를 내부에서 사용하는 하나의 방화벽 IP 주소(다른 포트 번호)로 변환
  - HTTP 프락시와 게이트웨이는 원 서버에 새로운 TCP 연결
    - 웹 서버는 클라이언트의 IP 주소 대신 프락시 서버의 IP 주소를 봄
- 클라이언트 IP 주소를 사용하는 것은 큰 의미가 없음

## 11.4 사용자 로그인

- 웹 서버는 사용자 이름과 비밀번호로 인증할 것을 요구해서 사용자에게 명시적으로 식별 요청 가능
- 서버에서, 사용자가 사이트에 접근하기 전에 로그인 시키고자 한다면 `HTTP 401 Login Required` 응답코드를 브라우저로 보냄
- 다음 요청부터 `Authorization` 헤더에 그 정보를 기술하여 보냄

## 11.5 뚱뚱한 URL

- 사용자의 상태 정보를 포함하고 있는 URL을 뚱뚱한 URL이라 함
- 웹 서버와 통신하는 독립적인 HTTP 트랜젝션을 하나의 '세션' 혹은 '방문'으로 묶는 용도로 뚱뚱한 URL 사용 가능
- 뚱뚱한 URL은 사이트를 브라우징하는 사용자를 식별하는데 사용 가능
- 여러 가지 문제
  - **못생긴 URL**
  - **공유 불가능한 URL**
    - 특정 사용자의 세션에 대한 상태 정보를 포함하여, 누군가에게 보내게 되면 개인 정보를 공유할 가능성 존재
  - **캐시 사용 불가능**
    - URL로 만드는 것은, URL이 달라지기 때문에 기존 캐시에 불가능한 것을 의미
  - **서버 부하 가중**
    - 서버는 뚱뚱한 URL에 해당하는 HTML 페이지를 다시 그려야 함
  - **이탈**
    - 사용자가 링크를 타고 다른 사이트로 이동하거나 특정 URL을 요청해서 의도치 않게 세션에서 이탈하기 쉬움
    - 사용자가 이탈하면, 지금까지의 진척상황들(장바구니)이 초기화 될 수 있음
  - **세션 간 지속성 부재**
    - 사용자가 특정 URL을 북마킹하지 않는 이상, 로그아웃하면 모든 정보를 잃음

## 11.6 쿠키

### 11.6.1 쿠키의 타입

- **세션 쿠키(session cookie)**
  - 사용자가 사이트를 탐색할 때, 관련한 설정과 선호 사항들을 저장하는 임시 쿠키
  - 사용자가 브라우저를 닫으면 삭제
- **지속 쿠키(persistent cookie)**
  - 디스크에 저장되어, 브라우저를 닫거나 컴퓨터를 재시작하더라도 남아있음
  - 사용자가 주기적으로 방문하는 사이트에 대한 설정 정보나 로그인 이름을 유지하기 위해 사용
- `Discard` 파라미터가 설정되어 있거나, `Expires` 혹은 `Max-Age` 파라미터가 없으면 세션 쿠키가 됨

### 11.6.2 쿠키는 어떻게 동작하는가

- 쿠키는 임의의 `이름=값` 형태의 리스트를 가지고, 그 리스트는 `Set-Cookie` 혹은 `Set-Cookie2(확장 헤더)` 같은 HTTP 응답 헤더에 기술되어 사용자에게 전달
- 쿠키는 어떤 정보든 포함할 수 있지만, 서버가 사용자 추적 용도로 생성한 유일한 단순 식별 번호만 포함하기도 함
- 하지만 쿠키는 단순히 ID 번호에만 국한되지 않음
- 많은 웹 서버가 정보를 쿠키에 유지하려고 함

### 11.6.3 쿠키 상자: 클라이언트 측 상태

- 쿠키의 기본적인 발상
  - 브라우저가 서버 관련 정보를 저장
  - 사용자가 해당 서버에 접근할 때마다 그 정보를 함께 전송
- 브라우저는 쿠키 정보를 저장할 책임이 있는데 이를 **클라이언트 측 상태**라 함

- 구글 크롬 쿠키
  - `creation_utc` : 쿠키 생성 시점 (리눅스초)
  - `host_key` : 쿠키 도메인
  - `name` : 쿠키 이름
  - `value` : 쿠키 값
  - `path` : 쿠키와 관련된 도메인에 있는 경로
  - `expire_utc` : 쿠키 파기 시점 (리눅스초)

### 11.6.4 사이트마다 각기 다른 쿠키들

- 브라우저는 수백 수천 개의 쿠키를 가지고 있을 수 있지만, 모든 사이트에 전송하지는 않음
  - 쿠키를 모두 전달하면 성능 저하 유발
  - 쿠키는 대부분 서버에 특화된 이름/값 쌍을 포함하기에, 대부분 사이트에서는 인식하지 않는 무의미한 값
  - 모든 사이트에 쿠키 전체를 전달하는 것은, 신뢰하지 않느 사이트에서 가져갈 수 있어서 개인정보 문제 유발 가능
- 보통 브라우저는 쿠키를 생성한 서버에게만 쿠키에 담긴 정보 전달

### 11.6.5 쿠키와 세션 추적

- 쿠키는 웹 사이트에 수차례 트랜젝션을 만들어내는 사용자를 추적하는데 사용
- 전자상거래 웹 사이트는 사용자가의 쇼핑카트를 유지하려 세션 쿠키 사용

### 11.6.6 쿠키와 캐싱

- 쿠키 트랜젝션과 관련된 문서를 캐싱하는 것은 주의해야 함
- 이전사용자의 쿠키가 다른 사용자에게 할당되거나, 누군가의 개인 정보가 유출되는 상황이 일어날 수 있음
- 캐시를 다루는 원칙
  - 캐시되지 말아야 할 문서가 있다면 표시
  - `Set-Cookie` 헤더를 캐시하는 것에 유의
  - Cookie 헤더를 가지고 있는 요청 주의

### 11.6.7 쿠키, 보안 그리고 개인정보

- 개인정보를 다루거나 사용자를 추적하는 기술은 잘못된 의도로 사용 가능하기에 조심해야 함
- 쿠키에 대한 부정적인 여론이 많지만, 제공하는 개인정보를 누가 받는지 명확히 알고 사이트의 개인정보 정책에만 유의한다면, 쿠키에 고나련한 위험성보다 세션 조작이나 트랜젝션상의 편리함이 더 큼

