# 4. 스위치

> 네트워크의 가장 핵심장비
>
> 2계층 주소인 MAC 주소를 기반으로 동작
>
> 스위치는 네트워크 중간에서 패킷을 받아 필요한 곳에만 보내주는 네트워크의 중재자 역할

## 4.1 스위치 장비 동작

- 스위치는 네트워크에서 통신을 중재하는 장비
  - 스위치가 없던 시절에는 패킷을 전송할 때 서로 경합해 그로 인한 성능 저하가 컷음
  - 이런 경쟁을 없애고 패킷을 동시에 여러 장비가 서로 간섭 없이 통신하도록 도와주는 장비가 스위치
  - 스위치를 사용하면 여러 단말이 한꺼번에 통신 가능해 통신하기 위해 기다리거나 **충돌 때문에 대기하는 문제가 해결되고 네트워크 전체의 통신 효율성이 향상**됨
- 스위치의 핵심 역할은 누가 어느 위치에 있는지 파악하고 실제 통신이 시작되면 자신이 알고 있는 위치로 패킷을 정확히 전송하는 것
  - 이런 동작은 스위치가 2계층 주소를 이해하고 단말의 주소인 MAC 주소와 단말이 위치하는 인터페이스 정보를 매핑한 MAC 주소 테이블을 갖고 있어서 가능
- 스위치는 전송하려는 패킷의 헤더 안에 있는 **2계층 목적지 주소를 확인하고 MAC 주소 테이블에서 해당 주소가 어느 포트에 있는지 확인해 해당 패킷을 그 포트로만 전송**
- 이런 역할을 수행하기 위해 스위치는 MAC 주소와 포트가 매핑된 MAC 주소 테이블이 필요

### 4.1.1 플러딩

- 스위치는 부팅하면 네트워크 관련 정보가 아무것도 없음
  - 이때 스위치는 네트워크 통신을 중재하는 자신의 역할을 하지 못하고 허브처럼 동작
  - **이와 같이 스위치가 허브와 같이 모든 포트로 패킷을 흘리는 동작 방식을 플러딩이라고 함**
- 이런 플러딩 동작은 스위치의 정상적인 동작이지만 많아지면 스위치가 제 역할을 못하게 됨

### 4.1.2 어드레스 러닝

- 스위치가 패킷의 도착지 MAC 주소를 확인하여 원하는 포트로 포워딩하는 스위치의 동작을 정상적으로 수행하려면 MAC 주소 테이블을 만들고 유지해야 함
- MAC 주소 테이블은 어느 위치(포트)에 어떤 장비(MAC 주소)가 연결되었는지에 대한 정보가 저장된 임시 테이블
- **이런 MAC 주소 테이블을 만들고 유지하는 과정을 어드레스 러닝이라 함**

### 4.1.3 포워딩/필터링

- 스위치의 동작은 매우 간단함
  - 패킷이 스위치에 들어온 경우, **MAC 주소를 확인해 자신이 가진 MAC 테이블과 비교해 있으면 해당 포트로 패킷을 포워딩**
  - 이때 **다른 포트로는 해당 패킷을 보내지 않으므로 이 동작을 필터링이라 함**
- 스위치는 이런 포워딩과 필터링을 통해 목적지로만 패킷이 전달되도록 동작
- 스위치에서는 포워딩과 필터링 작업이 여러 포트에서 동시에 수행 가능함
- 통신이 다른 포트에 영향을 미치지 않으므로 다른 포트에서 기존 통신작업으로부터 독립적 동작 가능함

## 4.2 VLAN

### 4.2.1 VLAN ?

- 물리적 배치와 상관없이 LAN을 논리적으로 분할, 구성하는 기술
- 최근에는 전화기, 복합기, 스마트폰과 같이 PC 외에도 다수의 단말이 네트워크에 연결되므로 네트워크 분할이 더 중요
- VLAN을 나누면 하나의 장비를 서로 다른 네트워크를 갖도록 논리적으로 분할한 것
  - 유니캐스트뿐만 아니라 브로드캐스트도 VLAN 간에 통신 불가능함
  - VLA 간의 통신이 필요하다면 서로 다른 네트워크 간의 통신이므로 3계층 장비가 필요

### 4.2.2 VLAN의 종류와 특징

- 포트 기반 VLAN
  - 스위치를 논리적으로 분할해 사용하는 것이 목적인 VLAN
  - 일반적으로 언급하는 대부분의 VLAN
  - 어떤 단말이 접속하든지 스위치의 특정 포트에 VLAN을 할당하면 할당된 VLAN에 속함
- MAC 주소 기반 VLAN
  - 사용자들의 자리 이동이 많아지면서 개발됨
  - 스위치에 연결되는 단말의 MAC 주소를 기반으로 VLAN을 할당하는 기술
  - 단말이 연결되면 단말의 MAC  주소를 인식한 스위치가 해당 포트를 지정한 VLAN으로 변경함
  - 단말에 따라 VLAN  정보가 바뀔  수 있어 Dynamic VLAN이라고도 부름

## 4.3 STP

- IT 환경에서는 SPoF로 인한 장애를 피하기 위해 다양한 노력을 함
  - SPoF(Single Point of Failure: 단일 장애점) : 하나의 시스템에서 장애가 발생했을 때 전체 시스템의 작동이 멈추는 요소
- SPoF를 피하기 위해 스위치 두 대로 네트워크를 디자인한다면
  - 패킷이 네트워크를 따라 계속 전송되므로 네트워크를 마비시킬 수 있음, 이를 네트워크 루프라고 함

### 4.3.1 루프(Loop) ?

#### 4.3.1.1 브로드캐스트 스톰

- 루프로 문제가 발생했을 때 대부분의 문제 원인
- 루프 구조로 네트워크가 연결된 상태에서 단말에서 브로드캐스트를 발생시키면 스위치는 이 패킷을 패킷이 유입된 포트를 제외한 모든 포트로 플러딩함
- 플러딩된 패킷은 다른 스위치로도 보내지고 이 패킷을 받은 스위치는 패킷이 유입된 포트를 제외한 모든 포트로 다시 플러딩함
- 루프 구조 상태에서는 이 패킷이 계속 돌아가는데 이것을 브로드캐스트 스톰이라고 함

#### 4.3.1.2 스위치 MAC 러닝 중복 문제

- 루프 구조 상태에서는 브로드캐스트뿐만 아니라 유니캐스트도 문제를 일으킴
- 같은 패킷이 루프를 돌아 도착지 쪽에서 중복 수신되는 혼란을 일으키기도 하지만 중간에 있는 스위치에서도 MAC 러닝 문제 발생
- 스위치는 출발지 MAC 주소를 학습하는데 직접 전달되는 패킷과 스위치를 돌아 들어간 패킷 간의 포트가 달라 MAC 주소를 정상적으로 학습 불가능
- 스위치 MAC 주소 테이블에서는 하나의 MAC 주소에 대해 하나의 포트만 학습 가능하므로 동일한 MAC 주소가 여러 포트에서 학습되면 MAC 테이블이 반복 갱신되어 정상적으로 동작하지 않음
- 이 현상을 MAC 어드레스 플래핑(MAC Address Flapping)이라 함

##### 네트워크에 루프가 발생할 경우

- 앞의 문제들 때문에 네트워크가 정상적으로 동작하지 않으므로 루프가 생기지 않도록 미리 네트워크에 조치해야 함
- 루프 구성 포트 중 하나의 포트만 사용하지 못하도록 셧다운(Shutdown)되어 있어도 예방 가능함
- 루프를 자동 감지해 포트를 차단하고 장애 때문에 우회로가 없을 때 차단된 포트를 스위치 스스로 다시 풀어주는 스페닝 트리 프로토콜이 개발 됨

### 4.3.2 STP ?

- 스패닝 트리 프로토콜(Spanning Tree Protocol)은 루프를 확인하고 적절히 포트를 사용하지 못하게 하여 루프를 예방하는 메커니즘
- 용어 그래도 나무처럼 뿌리부터 가지까지 루프가 생기지 않도록 유지하는 것이 STP의 목적

#### 4.3.2.1 스위치 포트의 상태 및 변경 과정

- STP가 동작 중인 스위치에서는 루프를 막기 위해 스위치 포트에 신규 스위치가 연결되면 바로 트래픽이 흐르지 않도록 차단함
- 그리고 해당 포트로 트래픽이 흘러도 되는지 확인하기 위해 BPDU를 기다려 학습하고 구조를 파악한 후 트래픽을 흘리거나 루프 구조인 경우, 차단 상태를 유지함
- 차단 상태에서 트래픽이 흐를 때까지 스위치 포트의 상태는 다음 4가지로 구분 가능
  - Blocking
    - 패킷 데이터를 차단한 상태로 상대방이 보내는 BPDU를 기다림
  - Listening
    - 리스닝 상태는 해당 포트가 전송 상태를 변경되는 것을 결정하고 준비하는 단계
  - Learning
    - 러닝 상태는 이미 해당 포트를 포워딩하기로 결정하고 실제로 패킷 포워딩이 일어날 때 스위치가 곧바로 동작하도록 MAC 주소를 러닝하는 단계
  - Forwarding
    - 패킷을 포워딩하는 단계. 정상적인 통신 가능

#### 4.3.2.2 STP 동작 방식

- 루트 스위치
  - 네트워크 상에서 뿌리가 되는 가장 높은 스위치
  - 이 스위치를 통해 모든 BPDU가 교환되도록 함
- 모든 스위치는 처음에 자신을 루트 스위치로 인식해 동작
- BPDU를 통해 2초마다 자신이 루트 스위치임을 광고하는데 새로운 스위치가 들어오면 서로 교환된 BPDU에 들어 있는 브릿지 ID 값을 비교하여 ID 값이 더 적은 스위치를 루트 스위치로 선정
- STP는 루프를 예방하기 위해 다음과 같이 동작
  1. 하나의 루트 스위치 선정
     - 전체 네트워크에 하나의 루트 스위치 선정
     - 자신을 전체 네트워크의 대표 스위치로 적은 BPDU를 옆 스위치로 전달
  2. 루트가 아닌 스위치 중 하나의 루트 포트를 선정
     - 루트 브릿지로 가는, 경로가 가장 짧은 포트를 루트 포트라고 함
     - 루트 브릿지에서 보낸 BPDU를 받는 포트
  3. 하나의 세그먼테 하나의 지정 포트를 선정
     - 스위치와 스위치가 연결되는 포트는 하나의 지정 포트를 선정
     - 스위치 간의 연결에서 이미 루트 포트로 선정된 경우, 반대쪽이 지정 포트로 선정되어 양쪽 모두 포워딩 상태가 됨
     - 스위치 간의 연결에서 아무도 루트 포트가 아닐 경우, 한쪽은 지정 포트로 선정되고 다른 한쪽은 대체 포트가 되어 차단 상태
     - BPDU가 전달되는 포트

